<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Unit tests</title>

		<meta name="description" content="Women Who Code technical interview preparation: unit tests">
		<meta name="author" content="Elze Hamilton">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/reveal.min.css">
		<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/css/theme/sky.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/css/zenburn.css">

		<link rel="stylesheet" href="../common/css/style.css">

		<!--[if lt IE 9]>
		<script src="//cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<p class="presentation-header"><small>Unit testing | <a href="http://geekitude.com">Elze Hamilton</a> / <a href="http://twitter.com/elze">@elze</a> | Women Who Code tech interview preparation</small></p>
			<p class="presentation-header" style="text-align: center; font-size: 10px">Press Esc to see thumbnails of all slides.</p>
			<!-- Any section element inside of this container is displayed as a slide -->

			<div class="slides">			
				<section>
					<h2>Unit testing</h2>
					<p>
						<small>By <a href="http://geekitude.com">Elze Hamilton</a> / <a href="http://twitter.com/elze">@elze</a></small>
					</p>
					<p>
						<small>Women Who Code technical interview preparation series</small>
					</p>
				</section>

				<section><!-- slide 2 -->
					<h3>Basic things to know about unit testing</h3>
					<p class="alterconf">Unit tests are automated. They are code.</p>
					<p class="alterconf">Each unit test (ideally) tests one method of one class: thus, "unit".</p>
					<p class="alterconf">Here is an example of a unit test for a very simple method.</p>					
<pre><code class="presentation">
public List<int> doubleListElements() {
	var origList = new List<int>([1, 2, 3]);
	List<int> listOfDoubles = new List<int>();
	foreach (int elem in origList) 
		listOfDoubles.Add(elem * 2);
	return listOfDoubles;
}
</code></pre>

<pre><code class="presentation">
public doubleListElements_should_return_a_list_of_doubled_values() {
	var doubledList = doubleListElements(); 
	Assert.IsEqual(2, doubledList[0]);
	Assert.IsEqual(4, doubledList[1]);
	Assert.IsEqual(6, doubledList[2]);
}
</code></pre>
				</section>

				<section><!-- slide 3 -->
					<h4 class="alterconf-left">Important things to know about unit tests:</h4>
					<p class="alterconf">Unit tests are supposed to test just the application code.</b></p>
					<p class="alterconf">That means they need to be completely self-contained, i.e. independent from other resources, such as databases or the network.</p>
					<p class="alterconf">A unit test of server-side code should not call the database or third-party API.</p>
					<p class="alterconf">A unit test of frontend code should not call the database, third-party API, or server-side code.</p>

<img class="img-left-no-shadow" src="img/codeArchitecture_20160919.png"/>

<img class="img-right-no-shadow" src="img/codeArchitecture_UnitTests_20160920.png"/>

				</section>

				<section><!-- slide 4 -->
					<h4 class="alterconf-left">Then how do you test the code that <i>does</i> use external resources?</h4>
					<p class="alterconf">You mock, stub, or fake the external resources.</p>
					<p class="alterconf">For that you use classes called <i>mocks</i>, <i>stubs</i>, or <i>fakes</i>.</p>
					<p class="alterconf">Some people think those terms signify different things, some think they are interchangeable.</p>
					<p class="alterconf">Those classes are usually generated by mock / fake / stub frameworks, but they can be written by hand.</p>										
					<p class="alterconf">Their essence is this: the mock / fake / stub class has the same methods as the external resource class, but it returns hard-coded data.</p>		
				</section>

				<section><!-- slide 5 -->
					<h4 class="alterconf-left">Simple example: hand-written stub class and how to use it</h4>
					<p class="alterconf">Here is the method under test. It is similar to the previous example, except that this one depends on an external resource, <code>repository</code>.</p>			
<pre><code class="presentation">
public List<int> doubleListElements(IRepository repository) {
	var origList = repository.GetList();
	List<int> listOfDoubles = new List<int>();
	foreach (int elem in origList) 
		listOfDoubles.Add(elem * 2);
	return listOfDoubles;
}
</code></pre>
					<p class="alterconf">Note that the <code>IRepository</code> type starts with I. In C#, this notation means it is an interface. They play a role in unit testing that we will see soon.</p>
					<p class="alterconf">Java and PHP have interfaces too. Many other languages don't have them, but that's not really important. What is important is that they have inheritance, because it plays a big part in creating mocks, stubs, and fakes.</p>
					</section>

				<section><!-- slide 6 -->
					<h4 class="alterconf">Back to the example</h4>
					<p class="alterconf">The <code>IRepository</code> is a wrapper for the database (thus, "repository"). A database is an external resource. We can't use them in unit tests, so we need to mock / fake / stub the <code>IRepository</code> </p>
<pre><code class="presentation">
// The application code
interface IRepository {
	List<int> GetList();
}
public List<int> doubleListElements(IRepository repository) {
	var origList = repository.GetList();
	List<int> listOfDoubles = new List<int>();
	foreach (int elem in origList) 
		listOfDoubles.Add(elem * 2);
	return listOfDoubles;
}
// The mock / stub / fake FakeRepository class implements IRepository interface
class FakeRepository: IRepository {
	public List<int> GetList() {
		return [3, 5, 8];
	];
}
</code></pre>
				</section>

				<section><!-- slide 7 -->
					<h4 class="alterconf">Back to the unit test</h4>
					<p class="alterconf">Here is the previous unit test, rewritten with a <code>IRepository</code> fake.</p>
<pre><code class="presentation">
public doubleListElements_should_return_a_list_of_doubled_values() {
	IRepository repository = new FakeRepository();
	var doubledList = doubleListElements(repository); 
	Assert.IsEqual(6, doubledList[0]);
	Assert.IsEqual(10, doubledList[1]);
	Assert.IsEqual(16, doubledList[2]);
}
</code></pre>
					<p class="alterconf">And this is how we call this test:</p>
<pre><code class="presentation">
// doubleListElements() will call repository.GetList(), which in this case will be FakeRepository.GetList()
// The FakeRepository.GetList() will return the hardcoded list [3, 5, 8]
doubleListElements_should_return_a_list_of_doubled_values();
</code></pre>
</section>
				<section><!-- slide 8 -->
					<h3>Important question</h3>
					<p class="sixty-percent-left">Can you name the principle or principles that allowed to substitute <code>FakeRepository</code> for <code>IRepository</code> ? </p>
					<p class="sixty-percent-left fragment">Dependency injection. </p>
				</section>
				<section><!-- slide 9 -->
					<h4 class="alterconf">Simple explanation of dependency injection</h4>

					<p class="alterconf"><code>IRepository</code> object is a dependency: the <code>doubleListElements()</code> depends on it. It is being <i>injected</i>, i.e. passed as an argument, to the <code>doubleListElements()</code> method.</p>
					<p class="alterconf">If it were not passed, the <code>doubleListElements()</code> method would need to create it on its own: </p>
<pre><code class="presentation">
public List<int> doubleListElements() {
	IRepository repository = new Repository(connectionString);
	var origList = repository.GetList();
	List<int> listOfDoubles = new List<int>();
	foreach (int elem in origList) 
		listOfDoubles.Add(elem * 2);
	return listOfDoubles;
}
</code></pre>
					<p class="alterconf">Thus, <code>doubleListElements()</code> would need to know how to create an <code>IRepository</code> object. In that case, the <code>IRepository</code> object would be "hardcoded" in the method, and we could not substitute a fake <code>IRepository</code> object for it. </p>

				</section>

				<section><!-- slide 10 -->
					<h4>Dependency injection for languages without interfaces</h4>
					<p class="alterconf">Some programming languages don't have interfaces, but have abstract classes, e.g. Python.</p>
					<p class="alterconf">Ruby has neither interfaces nor abstract classes, but dependency injection in it is still possible. You will just need to find out how to do it for yourself, if Ruby is your language of choice.</p>
					<p class="alterconf">Javascript does not have classes or object-based inheritance at all, but you can still do dependency injection in it. The important thing is to inject an object that has the same method as the "real" object that encapsulates external dependency. </p>

<img class="img-left-no-shadow" src="img/interfaceRepository_20161006_480.png"/>

<img class="img-right-no-shadow" src="img/interfaceRepository_20161006_480.png"/>

				</section>

				<section><!-- slide 11 -->
					<h4>Exercise: Let's make something unit-testable</h4>
					<p class="alterconf">Let's say there is this method that calls a third party service: </p>
<pre><code class="presentation">
public List<User> createUsers() {
	WebRequest httpRequest = WebRequest.Create("http://foo.com/users");
	var response = httpRequest.GetReponse();
	Stream responseStream = response.GetResponseStream();	
	List<User> users = new List<User>();
	
    	using(StreamReader reader = new StreamReader(responseStream)) {
        	while((string line = reader.ReadLine()) != null) {
            		User user = new User(line);
            		users.Add(user);
        	}
        	reader.Close();
    	}	
	return users;
}
</code></pre>
				</section>
				
				<section><!-- slide 12 -->
					<h4>Another, simpler version, more like pseudocode</h4>
<p class="alterconf"><code>createUsers()</code> method reads data from a URL, and creates User objects based on the returned data. <code>WebRequest</code> and <code>Stream</code> are .NET framework classes, and we don't need to test them. User is our class.

</p>
<pre><code class="presentation">
public List<User> createUsers() { // Reads data from a URL, and creates User objects based on the returned data.
	WebRequest httpRequest = WebRequest.Create("http://foo.com/users");
	var response = httpRequest.GetReponse();
	Stream responseStream = response.GetResponseStream();	
	List<User> users = new List<User>();
	
    	string[] responseLines = response.ReadLines();
        foreach (string line in responseLines) {
            		User user = new User(line);
            		users.Add(user);
    	}	
	return users;
}
</code></pre>
				</section>

				<section><!-- slide 13 -->
					<h4 class="alterconf">One possible solution</h4>

<pre><code class="presentation">
public List<User> createUsers(string[] responseLines) {
	List<User> users = new List<User>();
        foreach (string line in responseLines) {
            		User user = new User(line);
            		users.Add(user);
    	}	
	return users;
}
</code></pre>
<p class="alterconf">In the code that calls <code>createUsers</code>: </p>
<pre><code class="presentation">
	WebRequest httpRequest = WebRequest.Create("http://foo.com/users");
	var response = httpRequest.GetReponse();
	Stream responseStream = response.GetResponseStream();	
	List<User> users = createUsers(responseStream.ReadLines());
</code></pre>
<p class="alterconf">So as you see, you created a <code>responseStream</code> object outside of the <code>createUsers</code> method, and injected the array of strings that it returns into the <code>createUsers</code> method. </p>
<p class="alterconf">You may point out the the first 3 lines before the call to <code>responseStream</code> are not unit-testable, and that would be correct. Not everything is unit-testable. But those three lines are pretty much out of the can. You do nothing but call .NET framework methods in them. If all your code does is call methods from a framework or third-party library, you don't need to unit-test it, because you can assume that third-party code has been tested. But if your code does its own processing (e.g. instantiating user objects from data, or doubling list elements), you need to unit-test is. </p>
				</section>

				<section><!-- slide 14 -->
					<h4>Mocks, fakes, and stubs</h4>
<p class="alterconf">Most of the time, however, we don't need to create these "fake" objects by hand. </p>
<p class="alterconf">For that, we use various mock frameworks. There are many of them, and usually they are specific to the programming language you use. </p>
					<ul>
						<li class="alterconf">Javascript: <b>Jasmine</b>, <b>ngMock</b> for Angular.js</li>
						<li class="alterconf">C#: <b>FakeItEasy</b> </li>
					</ul>
<p class="alterconf">... and many others. </p>
<p class="alterconf">NEED an example of how they are used. Maybe show how a method is spied on / how a method call is faked? </p>
			</section>
			<section><!-- slide 15 -->
				<h4>Example of mock framework: FakeItEasy</h4>
<p class="alterconf">We can rewrite the previous unit test in the FakeItEasy mock framework </p>
<pre><code class="presentation">
// The application code
interface IRepository {
	List<int> GetList();
}
public List<int> doubleListElements(IRepository repository) {
	var origList = repository.GetList();
	List<int> listOfDoubles = new List<int>();
	foreach (int elem in origList) 
		listOfDoubles.Add(elem * 2);
	return listOfDoubles;
}

doubleListElements_should_return_a_list_of_doubled_values() { 
	var repository = A.Fake<IRepository>();
        A.CallTo(() => repository.GetList()).Returns(new List<int>({3, 5, 8}));
	var doubledList = doubleListElements(repository); 
	Assert.IsEqual(6, doubledList[0]);
	Assert.IsEqual(10, doubledList[1]);
	Assert.IsEqual(16, doubledList[2]);
}
</code></pre>
<p class="alterconf">We have created a mock <code>IRepository</code> object with a mock <code>GetList()</code> method, and used it in our unit test. </p>
			</section>
			<section><!-- slide 15 -->
				<h4>Mocks, fakes, and stubs in Javascript</h4>
<p class="alterconf">Creating a mock object for third-party library, and checking if its method was called with the right arguments </p>
<p class="alterconf">The method under test is <code>GetList</code>. We are testing whether it calls 3rd party service correctly (with the right arguments). </p>
<pre><code class="presentation">
	function Service() {
	  GetList: function(specLibraryService, userPermObject) {
	    var myList = specLibraryService.GetDataList('SpecializedData/GetList', [userPermObject.userId, userPermObject.deptId]);
	  }
	}
	
	// Mock object
        var mockSpecializedLibraryService = {
            GetDataList: function(url, departmentId, userId) { 
		return [3, 5, 8]; 
		}
        };

    it('GetList_GoodRequest', function (done) { 
	// We are testing a GetList request of a service -- the service in our frontend.
	// The service in our frontend calls another service, one for one of our libraries, which is called SpecializedLibraryService
	// We will mock the SpecializedLibraryService object, because we can't include it in our test: it is an outside dependency
        var storeNum = 1;
	var dsSpy = spyOn(mockSpecializedLibraryService, 'GetDataList');
        var service = Service();		
	var userPermissionsObject = new UserPermissions { userId: "foo", deptId: "bar" }; // probably incorrect syntax
        service.GetList(mockSpecializedLibraryService, userPermissionsObject)
            .then((result) => {		
                expect(dsSpy).toHaveBeenCalled();
                var firstCall = dsSpy.calls.first();
                expect(firstCall.args[0]).toBe('SpecializedData/GetList');
                expect(firstCall.args[1].userId).toBe(userPermissionsObject.userId);
                expect(firstCall.args[1].deptId).toBe(userPermissionsObject.deptId);
            }).catch(() => {
                fail();
            }).finally(() => {
                done();
            });
    });
</code></pre>
<p class="alterconf">This test case seems trivial, but imagine that <code>GetList</code> transforms the argument <code>userPermissionsObject</code> in a non-trivial way before calling <code>specLibraryService.GetDataList</code> with it. Then this test case will seem justified. </p>
			</section>

			<section><!-- slide 16 -->
<p class="sixty-percent-left fragment">Why do we need to check if certain methods were called? </p>
<p class="sixty-percent-left fragment">Imagine that the call to <code>specLibraryService.GetDataList</code> depended on some complex if-then-else logic. Then there may be paths through the code in which it would get called, and others where it wasn't, so a simple look at the code would not be enough.  </p>
<p class="sixty-percent-left fragment">Also it is very useful to know that the arguments we were passing to <code>specLibraryService.GetDataList</code> were actually correct. That's what <code>expect(firstCall.args[1].userId).toBe(...)</code> does: </p>
<pre><code class="presentation">
        service.GetList(mockSpecializedLibraryService, userPermissionsObject)
            .then((result) => {		
                expect(dsSpy).toHaveBeenCalled();
                var firstCall = dsSpy.calls.first();
                expect(firstCall.args[0]).toBe('SpecializedData/GetList');
                expect(firstCall.args[1].userId).toBe(userPermissionsObject.userId);
                expect(firstCall.args[1].deptId).toBe(userPermissionsObject.deptId);
            });
</code></pre>
<p class="sixty-percent-left fragment">It makes sure that given a <code>userPermissionsObject</code> object, the correct fields of that object (<code>userId</code> and <code>deptId</code>) get passed to <code>SpecializedData/GetList</code>. Since <code>SpecializedData/GetList</code> is a remote call (to another server) we can't check the arguments that server receives. All we can do is to make sure that we are passing the correct argument. </p>
			</section>

			<section><!-- slide 16 -->
<h4 class="alterconf">Tasks to practice </h4>
<p class="sixty-percent-left fragment">Find a mock / fake / stub framework you like, or merely a popular one, like Jasmine for Javascript. </p>
<p class="sixty-percent-left fragment">Write a simple program that involves using an object. </p>

			</section>


			<section><!-- slide 16 -->
				<h4>Other important considerations for unit testability</h4>
<p class="alterconf">The fewer side effects a method has, the easier it is to unit-test. </p>
<p class="alterconf">Why? </p>
<p class="alterconf">If your method performs lots of calculations that have intermediate state -- lots of local variables -- your unit test can't "look" into that state and check if those calculations are being performed correctly. The intermediate state is fleeting. Spies can check whether some function was called, but they can't check if some complex loop-within-a-loop or multiple nested if-then-else statements are executed correctly.  </p>
<p class="alterconf">What to do? Try as much as possible to put that complex logic -- loops, if-then-else statements, etc. -- into their own methods. Make those methods return the value of the intermediate computation. </p>
<p class="alterconf">Then you'll be able to write a unit test that tests the return value of that computation. </p>
			</section>

			<section><!-- slide 17 -->
				<h4>What software engineering principles does this follow?</h4>
<p class="alterconf">This ties in with the so-called SOLID principles, specifically, with the first S. </p>
<p class="alterconf">The first S stands for Single responsibility. </p>
<p class="alterconf">This means a class or a method should only do one thing. For example: </p> 
<ul>
  <li class="alterconf">only read from a file</li>
  <li class="alterconf">only parse transaction lines </li>
  <li class="alterconf">only calculate interest </li>
  <li class="alterconf">only generate a PDF document </li>
					</ul>
<p class="alterconf">... as opposed to a method that reads transaction lines from a file, calculates interest earned for that time period, and generates a PDF. </p> 
			</section>


			<section><!-- slide 18 -->
				<h4>Example for the previous slide</h4>
				<h4>A method that does too much</h4>
<p class="alterconf">This method computes the interest for the account AND generates the account statement. </p>
<pre><code class="presentation">
class Account { 
  public float InterestRate { get; set;}
  public List<Transaction> transactions { get; set;}
  public float computeAverageDailyBalance(Datetime beginDate, Datetime endDate) {
     // Assume that Account class has a method getTransactionList that returns all transactions between given dates
     List<Transaction> transactionsForThisTimePeriod = getTransactionList(beginDate, endDate);
     int numDays = endDate.Subtract(beginDate).Days;
     float balanceSum = 0;
     foreach (var transaction in transactionsForThisTimePeriod) 
  	balanceSum += transaction.amount;
     return averageDailyBalance = balanceSum / numDays;
  }
  public PdfDocument generatePdfStatement(int numDays, PdfWriter pdfWriter) {
    double interest = account.averageDailyBalance(numDays) * account.InterestRate * numDays / 365;
    // Here it adds a new "transaction" to the list of transactions for this account,
    // which shows that interest was deposited to the account
    account.transactions.Add(new Transaction {type = Credit, amount = interest }).ToList<string>();
    return pdfWriter.GeneratePdf(transactionsList);
}
</code></pre>
<p class="alterconf">Which parts of this method are unit-testable? </p> 
<p class="alterconf">Does it allow us to verify that the PDF document is returned? </p> 
<p class="alterconf">Does it allow to check the amount of interest that was deposited to the account? </p> 
<p class="alterconf">How do we check the latter? </p> 
<p class="alterconf">We need to break it up the method. How? </p> 
			</section>
			<section><!-- slide 18 -->
				<p class="sixty-percent-left fragment">How do we break up the previous method?</p>
<pre><code class="presentation bigger-height">
class Account {
  public List<Transaction> transactions { get; set;}
  public float InterestRate { get; set;}
  public float computeAverageDailyBalance(Datetime beginDate, Datetime endDate) {
     // Assume that Account class has a method getTransactionList that returns all transactions between given dates
     List<Transaction> transactionsForThisTimePeriod = getTransactionList(beginDate, endDate);
     int numDays = endDate.Subtract(beginDate).Days;
     float balanceSum = 0;
     foreach (var transaction in transactionsForThisTimePeriod) 
  	balanceSum += transaction.amount;
     return averageDailyBalance = balanceSum / numDays;
  }

  public float computeInterest(float averageDailyBalance, float interestRate, int numDays) {
    return averageDailyBalance * interestRate * numDays / 365; // To keep this code sample simple, we'll assume all years have 365 days
  }

  public PdfDocument generatePdfStatement(int numDays, PdfWriter pdfWriter) {
    float interest = 
	computeInterest(computeAverageDailyBalance(numDays) * InterestRate * numDays);
    transactions.Add(new Transaction {type = Credit, amount = interest });
    List<string> transactionsList = transactions.ToList<string>();
    return pdfWriter.CreateDocument(transactionsList);
  }
}
</code></pre>
			</section>
				<section><!-- slide 20 -->
<p class="alterconf">What can be unit-tested now? </p> 
<p class="alterconf fragment">Computing the average daily balance, interest, and generation of the PDF statement can all be unit-tested now. </p> 
			</section>

				<section><!-- slide 21 -->
					<h4 class="alterconf">Here are some possible unit tests</h4>
<pre><code class="presentation">
public averageDailyBalance_test() {
  // Account account = new Account({StartingAmount = 300.00, /* DaysInBillingCycle = 25, */ InterestRate = 0.01,
  // Instead of StartingAmount let's just use an initial transaction, which
 Account account = new Account({StartingAmount = 300.00, /* DaysInBillingCycle = 25, */ InterestRate = 0.01,
	Transactions = new List<Transaction>({ new Transaction {Type = D, Amount = 200, Date = "2016-10-10"}, new Transaction {Type = Credit, Amount = 100, Date = "2016-10-20"})});
  float expectedAverageDailyBalance = 200; 
  // $4575 / 25 = $183 -- What?
  // (300 * 10 + 100 * 10 + 200 * 10) / 30 = 6000 / 30 = 200

  // expectedInterest = averageDailyBalance * interestRate * numDays / 365; = 200 * 0.01 * 30 / 365  = 0.16;
  float expectedInterest = 0.16;
  Assert.IsEqual(expectedAverageDailyBalance, computeAverageDailyBalance(30));
  Assert.IsEqual(expectedInterest, computeInterest(computeAverageDailyBalance(30), account.InterestRate, 30));
}
</code></pre>
</section>

				<section><!-- slide 21 -->


<p class="alterconf fragment">But suppose <code>PdfWriter</code> class is written by a third party, and you can't test its functions, such as <code>CreateDocument</code>, directly. Sometimes you get an error trying to call it. Its maintainers say that the error is on your end: you are not passing the arguments correctly. How would you verify that you are passing them correctly? </p> 
<p class="alterconf fragment">Can you test that <code>transactionsList</code> that you are passing to <code>CreateDocument</code> is correct? Not directly, because they are created inside the method <code>generatePdfStatement</code>. So how would you test that you are calling this method correctly? </p> 
			</section>

				<section><!-- slide 21 -->


<p class="alterconf fragment">This is where mocks come into picture. You need to mock this method call.</p>

<p class="alterconf fragment">What that means that you create a fake of the <code>PdfWriter</code> class -- a fake object that implements (in a fake way) the "shell" of the third-party method you want to test. It implements only enough of that method so you could check if this method was called and with what arguments.</p>

<p class="alterconf fragment">That's where mock, stub, and fake frameworks are helpful, because you don't have to write that code yourself. Instead, here is an example in FakeItEasy of how you could do it. (A precondition for it is that <code>PdfWriter</code> needs to implement an interface, e.g. <code>IPdfWriter</code>.)</p>

  var fakePdfWriter = A.Fake<PdfWriter>();
  // Maybe this shouldn't be a fake? After all, we want to test if the arguments are being passed correctly
  // to pdfWriter.CreateDocument(). So we need to create a list of real Transaction objects.
  //var transactionList = new List<A.Fake<Transaction>>(); 
  var numberOfDays = 30;
  var transactions = new List<Transaction>({ new Transaction {Type = D, Amount = 200}, new Transaction {Type = Credit, Amount = 175});
  Account account = new Account({StartingAmount = 300.00, DaysInBillingCycle = 25, InterestRate = 0.03,
	Transactions = transactions);

  var transactionsAndInterest = transactions.Add(account.computeInterest(numberOfDays)); // 

  //A.CallTo(() => pdfWriter.CreateDocument(account.Transactions)).Returns(null); // we don't need it to return an actual PDF document
  //A.CallTo(() => accountService.GetPendingAccountRequests("M")).Returns(pendingAccountsRequestsTypeM);

 // Do we need A.CallTo at all? If we don't need to specify what the mock of pdfWriter.CreateDocument returns, do we need this at all? Will the mock function be called just because it was created when the whole mock was created?

  PdfDocument fakePdfDocument = account.generatePdfStatement(30, fakePdfWriter);
  A.CallTo(() => fakePdfWriter.CreateDocument(transactionsAndInterest)).MustHaveHappened();

<p class="alterconf fragment">What that last statement is checking is that a call to <code>CreateDocument</code> happened with the exact arguments that we are passing to it, which is the list of account transactions with the last one being the computed interest. If it passes the test, you have a strong reason to believe that you on your end haven't changed anything about how you are calling the third-party function. </p>

			</section>


				<section><!-- slide 21 -->
<p class="alterconf">How would you write mocks, fakes, and stubs to facilitate the testing of the above example? </p> 
<pre><code class="presentation">
	// The actual method under test
  public List<PendingAccountRequest> ApprovePendingAccountRequests(AccountService accountService, char[] accountTypes)	{
    foreach (char accountType in accountTypes) {
      int retVal = accountService.ApprovePendingAccountRequests(accountType);
    }
  }
</code></pre>
<p class="alterconf"><code>AccountService.ApprovePendingAccountRequests</code> is a third party service. We can't test if it works correctly. The only thing we can test is whether we are calling it correctly, i.e. with the right arguments, the right number of times. </p>
<p class="alterconf">This method, given an account service and a list of account types, iterates through the list of account types and calls the account service to approve that request.</p>
<p class="alterconf">Each account type is designated by one letter, e.g. C for Checking, S for Savings, M for Money Market.</p>
<p class="alterconf">You want to test if <code>ApprovePendingAccountRequests</code> method is being called off the <code>accountService</code> for every account type in the list. </p>
<p class="alterconf">Checking the <code>retVal</code>s that are being returned is not enough: you also want to know if <code>accountService.ApprovePendingAccountRequests</code> is being called with the right arguments. </p>
</section>
				<section><!-- slide 21 -->
<p class="alterconf">You could write a unit test like this. </p> 

<pre><code class="presentation">
  // Setting up the fake and real objects for the test
  var accountService = A.Fake<AccountService>();
  A.CallTo(() => accountService.GetPendingAccountRequests("C")).Returns(pendingAccountsRequestsTypeC);
  A.CallTo(() => accountService.GetPendingAccountRequests("M")).Returns(pendingAccountsRequestsTypeM);
  var accountController = new AccountController(accountService); // AccountController is under test, so it has to be real
  var pendingRequests = accountController.ApprovePendingAccountRequests(["C", "M"]);
  // Checking the test results
  A.CallTo(() => accountService.GetPendingAccountRequests()).MustHaveHappened(Repeated.Exactly.Twice);
  A.CallTo(() => accountService.GetPendingAccountRequests("C")).MustHaveHappened(Repeated.Exactly.Once);
  A.CallTo(() => accountService.GetPendingAccountRequests("M")).MustHaveHappened(Repeated.Exactly.Once);
</code></pre>


			</section>


			<section><!-- slide 12 -->
					<h3>THE END</h3>
					<p>&nbsp;</p>
					<p><a href="http://geekitude.com">Elze Hamilton</a> / <a href="http://twitter.com/elze">@elze</p>
			</section>

			</div>
		</div>

		<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/head.min.js"></script>
		<script src="http://cdn.jsdelivr.net/reveal.js/3.0.0/js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: '//cdn.jsdelivr.net/reveal.js/3.0.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: '//cdn.jsdelivr.net/reveal.js/3.0.0/plugin/notes/notes.js', async: true }
				]
			});

		</script>

<script type="text/javascript">
sc_project=2721969;
sc_invisible=0;
sc_security="5cfe5782";
</script>

<script type="text/javascript"
src="http://www.statcounter.com/counter/counter.js"></script><noscript><div
class="statcounter"><a title="site stats"
href="http://www.statcounter.com/free-web-stats/"
target="_blank"><img class="statcounter"
src="http://c29.statcounter.com/2721969/0/5cfe5782/0/"
alt="free hit counter" ></a></div></noscript>
<!-- End of StatCounter Code -->
	</body>
</html>
